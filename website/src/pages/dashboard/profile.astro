---
import DashboardLayout from '../../components/DashboardLayout.astro';

const title = 'Profile';
const description = 'View your account details.';
---
<DashboardLayout title={title} description={description}>
  <section class="container py-5" style="max-width: 600px;">
    <h1 class="text-center mb-4">Profile</h1>
    <dl class="row">
      <dt class="col-sm-4">First Name</dt>
      <dd class="col-sm-8" id="profile-first-name"></dd>
      <dt class="col-sm-4">Last Name</dt>
      <dd class="col-sm-8" id="profile-last-name"></dd>
      <dt class="col-sm-4">Email</dt>
      <dd class="col-sm-8" id="profile-email"></dd>
      <dt class="col-sm-4">Phone</dt>
      <dd class="col-sm-8" id="profile-phone"></dd>
      <dt class="col-sm-4">Payment Preference</dt>
      <dd class="col-sm-8" id="profile-payment"></dd>
      <dt class="col-sm-4">Domains</dt>
      <dd class="col-sm-8" id="profile-domains"></dd>
      <dt class="col-sm-4">Tests</dt>
      <dd class="col-sm-8" id="profile-tests"></dd>
    </dl>
    <div class="text-center mt-4">
      <a href="/dashboard/settings" class="btn btn-primary">Edit Profile</a>
    </div>
  </section>
  <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE =
        window.API_BASE_URL || 'https://api.bluefroganalytics.com:6001';
      const firstEl = document.getElementById('profile-first-name');
      const lastEl = document.getElementById('profile-last-name');
      const emailEl = document.getElementById('profile-email');
      const phoneEl = document.getElementById('profile-phone');
      const payEl = document.getElementById('profile-payment');
      const domEl = document.getElementById('profile-domains');
      const testsEl = document.getElementById('profile-tests');

      const populate = data => {
        if (data.first_name) firstEl.textContent = data.first_name;
        if (data.last_name) lastEl.textContent = data.last_name;
        if (data.email) emailEl.textContent = data.email;
        if (data.phone) phoneEl.textContent = data.phone;
        if (data.payment_preference) payEl.textContent = data.payment_preference;
        if (Array.isArray(data.domains)) domEl.textContent = data.domains.join(', ');
        if (data.tests) {
          testsEl.textContent = Object.entries(data.tests)
            .map(([k, v]) => `${k}=${v}`)
            .join(', ');
        }
      };

      const init = () => {
        window.onAuthStateChanged(window.firebaseAuth, async user => {
          if (!user) {
            window.location.href = '/login';
            return;
          }
          const token = await user.getIdToken();
          const res = await fetch(`${API_BASE}/api/profile`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            populate(await res.json());
          }
        });
      };

      if (window.firebaseAuth) {
        init();
      } else {
        document.addEventListener('firebase-init', init, { once: true });
      }
    });
  </script>
</DashboardLayout>
