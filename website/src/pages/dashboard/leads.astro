---
import DashboardLayout from '../../components/DashboardLayout.astro';

const title = 'Leads';
const description = 'View and purchase collected leads.';
---
<DashboardLayout title={title} description={description}>
  <section class="container py-5">
    <h1 class="text-center mb-4">Leads</h1>
    <ul class="nav nav-pills mb-4" id="lead-tabs">
      <li class="nav-item">
        <button class="nav-link active" data-type="maps">Maps Leads</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-type="domains">Domains</button>
      </li>
    </ul>
    <div class="row mb-3 g-2 align-items-end">
      <div class="col-md-6">
        <input id="lead-search" type="text" class="form-control" placeholder="Search" />
      </div>
      <div class="col-auto">
        <button id="lead-search-btn" class="btn btn-secondary">Search</button>
      </div>
      <div class="col-auto">
        <button id="download-csv" class="btn btn-primary d-none" disabled>Download CSV</button>
      </div>
      <div class="col-auto">
        <span id="selected-count" class="small text-muted"></span>
      </div>
    </div>
    <ul class="nav nav-pills mb-3 d-none" id="filter-tabs">
      <li class="nav-item">
        <button class="nav-link active" data-filter="all">All</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-filter="phone">Has Phone</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-filter="website">Has Website</button>
      </li>
    </ul>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead id="lead-head"></thead>
        <tbody id="lead-body"></tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
      <button id="prev-page" class="btn btn-secondary" disabled>Previous</button>
      <span id="page-info"></span>
      <button id="next-page" class="btn btn-secondary" disabled>Next</button>
    </div>
  </section>
  <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE =
        window.API_BASE_URL || 'https://api.bluefroganalytics.com:6001';
      const PAGE_SIZE = 1000;
      const headEl = document.getElementById('lead-head');
      const bodyEl = document.getElementById('lead-body');
      const searchEl = document.getElementById('lead-search');
      const searchBtn = document.getElementById('lead-search-btn');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      const pageInfo = document.getElementById('page-info');
      const tabs = document.querySelectorAll('#lead-tabs .nav-link');
      const filterTabs = document.querySelectorAll('#filter-tabs .nav-link');
      const filterWrapper = document.getElementById('filter-tabs');
      let type = 'maps';
      let page = 1;
      let filter = 'all';
      let serverTotal = 0;
      let allRows = [];
      const selected = new Map();
      const downloadBtn = document.getElementById('download-csv');
      const countEl = document.getElementById('selected-count');

      const updateCount = () => {
        const count = selected.size;
        countEl.textContent = count ? `${count} selected` : '';
        downloadBtn.disabled = count === 0;
      };

      const downloadCsv = () => {
        const lines = [];
        if (type === 'domains') {
          lines.push('Domain');
          selected.forEach(cols => {
            lines.push(cols[0]);
          });
        } else {
          lines.push('Business,Address,Phone,Website');
          selected.forEach(cols => {
            const escaped = cols.map(c => `"${c.replace(/"/g, '""')}"`);
            lines.push(escaped.join(','));
          });
        }
        const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'leads.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };

      const render = data => {
        headEl.innerHTML = '';
        bodyEl.innerHTML = '';
        const rows = data.results;
        downloadBtn.classList.toggle('d-none', rows.length === 0);
        const buildKey = r =>
          type === 'domains'
            ? r.domain
            : `${r.name || ''}|${r.address || ''}|${r.phone || ''}`;
        if (type === 'domains') {
          headEl.innerHTML =
            '<tr><th><input type="checkbox" id="lead-select-all" /></th><th>Domain</th></tr>';
          if (!rows.length) {
            bodyEl.innerHTML = '<tr><td colspan="2" class="text-center">No leads found.</td></tr>';
          } else {
            rows.forEach(r => {
              const key = buildKey(r);
              const tr = document.createElement('tr');
              tr.innerHTML = `\n              <td><input type="checkbox" class="form-check-input lead-cb" data-key="${key}"/></td>\n              <td>${r.domain}</td>\n            `;
              bodyEl.appendChild(tr);
            });
          }
        } else {
          headEl.innerHTML =
            '<tr><th><input type="checkbox" id="lead-select-all" /></th><th>Business</th><th>Address</th><th>Phone</th><th>Website</th></tr>';
          if (!rows.length) {
            bodyEl.innerHTML = '<tr><td colspan="5" class="text-center">No leads found.</td></tr>';
          } else {
            rows.forEach(r => {
              const key = buildKey(r);
              const tr = document.createElement('tr');
              tr.innerHTML = `\n              <td><input type="checkbox" class="form-check-input lead-cb" data-key="${key}"/></td>\n              <td>${r.name || ''}</td><td>${r.address || ''}</td><td>${r.phone || ''}</td><td>${r.website || ''}</td>\n            `;
              bodyEl.appendChild(tr);
            });
          }
        }
        bodyEl.querySelectorAll('.lead-cb').forEach(cb => {
          const key = cb.dataset.key;
          if (selected.has(key)) cb.checked = true;
          cb.addEventListener('change', () => {
            if (cb.checked) {
              const row = cb.closest('tr');
              const cols = Array.from(row.querySelectorAll('td')).slice(1).map(td => td.textContent.trim());
              selected.set(key, cols);
            } else {
              selected.delete(key);
            }
            updateCount();
          });
        });
        const selectAll = document.getElementById('lead-select-all');
        if (selectAll) {
          selectAll.checked = Array.from(bodyEl.querySelectorAll('.lead-cb')).every(cb => cb.checked);
          selectAll.addEventListener('change', () => {
            bodyEl.querySelectorAll('.lead-cb').forEach(cb => {
              cb.checked = selectAll.checked;
              cb.dispatchEvent(new Event('change'));
            });
          });
        }
        const totalPages = Math.max(1, Math.ceil(serverTotal / PAGE_SIZE));
        pageInfo.textContent = `Page ${page} of ${totalPages}`;
        prevBtn.disabled = page <= 1;
        nextBtn.disabled = page >= totalPages;
        updateCount();
      };

      const filterAndRender = () => {
        let rows = allRows;
        const search = searchEl.value.trim().toLowerCase();
        if (search) {
          rows = rows.filter(r => {
            const values = type === 'domains'
              ? [r.domain]
              : [r.name || '', r.address || '', r.phone || '', r.website || ''];
            return values.some(v => v.toLowerCase().includes(search));
          });
        }
        if (filter === 'phone') {
          rows = rows.filter(r => r.phone);
        } else if (filter === 'website') {
          rows = rows.filter(r => r.website);
        }
        render({ total: serverTotal, page, pageSize: PAGE_SIZE, results: rows });
      };

      const load = async user => {
        if (window.showSpinner) window.showSpinner();
        const token = await user.getIdToken();
        const url = new URL('/api/leads', API_BASE);
        url.searchParams.set('type', type);
        url.searchParams.set('page', page);
        url.searchParams.set('size', PAGE_SIZE);
        try {
          const res = await fetch(url.toString(), {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const data = await res.json();
            serverTotal = data.total;
            allRows = data.results;
            filterAndRender();
          }
        } catch {}
        if (window.hideSpinner) window.hideSpinner();
      };

      const init = () => {
        if (window.showSpinner) window.showSpinner();
        window.onAuthStateChanged(window.firebaseAuth, user => {
          if (!user) {
            window.location.href = '/login';
            return;
          }
          load(user);
          searchEl.addEventListener('input', filterAndRender);
          searchEl.addEventListener('keyup', e => {
            if (e.key === 'Enter') filterAndRender();
          });
          if (searchBtn) searchBtn.addEventListener('click', filterAndRender);
          prevBtn.addEventListener('click', () => {
            if (page > 1) {
              page--;
              load(user);
            }
          });
          nextBtn.addEventListener('click', () => {
            page++;
            load(user);
          });
          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              tabs.forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              type = tab.dataset.type;
              page = 1;
              filter = 'all';
              filterTabs.forEach(t => t.classList.remove('active'));
              filterTabs[0].classList.add('active');
              filterWrapper.classList.toggle('d-none', type === 'domains');
              load(user);
            });
          });
          filterTabs.forEach(ft => {
            ft.addEventListener('click', () => {
              filterTabs.forEach(f => f.classList.remove('active'));
              ft.classList.add('active');
              filter = ft.dataset.filter;
              filterAndRender();
            });
          });
          downloadBtn.addEventListener('click', downloadCsv);
          if (window.hideSpinner) window.hideSpinner();
        });
      };
      if (window.firebaseAuth) {
        init();
      } else {
        document.addEventListener('firebase-init', init, { once: true });
      }
    });
  </script>
</DashboardLayout>
