---
import { getCollection } from 'astro:content';
import BlogLayout from '../../components/BlogLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import BlogCarousel from '../../components/BlogCarousel.astro';

const posts = await getCollection('blog');
const sorted = posts.sort((a,b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const featured = sorted.slice(0,3);
const categories = {
  analytics: sorted.filter(p => (p.data.tags || []).includes('analytics')),
  seo: sorted.filter(p => (p.data.tags || []).includes('seo')),
  search: sorted.filter(p => (p.data.tags || []).includes('search')),
};
---
<BlogLayout>
  <h1>Blog</h1>
  <input id="blog-search" type="search" placeholder="Search posts..." />
  <section class="blog-hero bx--grid">
    <div class="bx--row">
      <div class="bx--col-sm-4 bx--col-md-6 bx--col-lg-12">
        <BlogCarousel posts={featured} />
      </div>
      <aside class="bx--col-sm-4 bx--col-md-2 bx--col-lg-4 recent-posts">
        <h3>Recent Posts</h3>
        <ul>
          {sorted.slice(0,5).map(p => <li><a href={p.url}>{p.data.title}</a></li>)}
        </ul>
      </aside>
    </div>
  </section>
  <section class="blog-tabs bx--grid">
    <div data-tabs class="bx--tabs">
      <ul class="bx--tabs__nav" role="tablist">
        <li class="bx--tabs__nav-item bx--tabs__nav-item--selected" data-target="#tab-analytics" role="tab">Analytics</li>
        <li class="bx--tabs__nav-item" data-target="#tab-seo" role="tab">SEO</li>
        <li class="bx--tabs__nav-item" data-target="#tab-search" role="tab">Search</li>
      </ul>
      <div id="tab-analytics" class="bx--tab-content" role="tabpanel">
        {categories.analytics.length ? categories.analytics.map(p => <BlogPostCard post={p} />) : <p>No articles found.</p>}
      </div>
      <div id="tab-seo" class="bx--tab-content" role="tabpanel" hidden>
        {categories.seo.length ? categories.seo.map(p => <BlogPostCard post={p} />) : <p>No articles found.</p>}
      </div>
      <div id="tab-search" class="bx--tab-content" role="tabpanel" hidden>
        {categories.search.length ? categories.search.map(p => <BlogPostCard post={p} />) : <p>No articles found.</p>}
      </div>
    </div>
  </section>
  <script src="/js/blog-search.js" defer></script>
  <script src="/js/hero-carousel.js" defer></script>
  <style>
    .blog-hero { margin-bottom: 2rem; }
    .recent-posts ul { list-style: none; padding: 0; }
    .recent-posts li { margin-bottom: 0.5rem; }
    .blog-tabs .bx--tab-content { padding-top: 1rem; }
  </style>
</BlogLayout>
