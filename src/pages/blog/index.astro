---
import { getCollection } from 'astro:content';
import BlogLayout from '../../components/BlogLayout.astro';

import FeaturedHero from '../../components/FeaturedHero.astro';
import RecentPosts from '../../components/RecentPosts.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';


const posts = await getCollection('blog');
const sorted = posts.sort((a,b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const featured = sorted.slice(0,3);
const tags = Array.from(new Set(posts.flatMap(p => p.data.tags || [])));
---
<BlogLayout>
  <div class="blog-page">
    <section class="blog-hero container">
      <FeaturedHero posts={featured} />
    </section>

    <section class="blog-search container">

      <div class="search-row row">

        <div class="col-12 col-lg-8">
          <div role="search">
            <label for="blog-search" class="visually-hidden">Search posts</label>
            <input id="blog-search" type="text" class="form-control" placeholder="Search posts..." />
          </div>
        </div>
        <div class="col-12 col-lg-8 tags-col">
          <div class="tag-filter">
            {tags.map(t => <span class="badge bg-secondary ms-2" data-tag={t}>{t}</span>)}
          </div>
        </div>
      </div>
    </section>

    <section class="blog-posts container">
      <div class="row">
        <div class="col-12 col-lg-8">
          <div class="row" id="posts-list">
            {sorted.map(post => (
              <div class="col-sm-6 col-lg-4">
                <BlogPostCard post={post} />
              </div>
            ))}
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <RecentPosts posts={sorted.slice(0,5)} />
        </div>
      </div>
    </section>
    <script src="/js/blog-search.js" defer></script>
    <style>
      .blog-hero { margin-bottom: 1rem; }
      .blog-search { margin-bottom: 2rem; }
      .search-row { display: flex; flex-wrap: wrap; align-items: center; }
      .tags-col { display: flex; align-items: center; justify-content: flex-end; }
      .tag-filter { margin-top: 0.5rem; }
      .search-row [role='search'] { width: 100%; }
      .tag-filter .badge { margin-left: 0.5rem; cursor: pointer; }
      .tag-filter .badge.active { background: #0b3d91; }
      #posts-list > div { margin-bottom: 2rem; }
   </style>
  </div>
</BlogLayout>
